<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>ESP32 Camera Stream</title>
        <style>
            body {
                margin: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
                background-color: #1e1e1e;
                color: #fff;
                font-family: sans-serif;
            }

            #camera {
                max-width: 90%;
                max-height: 80%;
                border: 4px solid #444;
                border-radius: 8px;
                background-color: #000;
            }

            #fps {
                margin-top: 10px;
                font-size: 18px;
                font-weight: bold;
                color: #0f0;
            }
        </style>
    </head>
    <body>
        <canvas id="camera"></canvas>
        <div id="fps">FPS: 0</div>
        <button id="play-btn">Play</button>
        <script>
            async function streamMJPEG() {
                const canvas = document.getElementById("camera");
                const ctx = canvas.getContext("2d");
                const fpsDisplay = document.getElementById("fps");

                const response = await fetch("/stream");
                const reader = response.body.getReader();
                let buffer = new Uint8Array();
                const decoder = new TextDecoder();

                function concatBuffer(oldBuf, newBuf) {
                    let tmp = new Uint8Array(oldBuf.length + newBuf.length);
                    tmp.set(oldBuf, 0);
                    tmp.set(newBuf, oldBuf.length);
                    return tmp;
                }

                let frameCount = 0;
                let lastTime = performance.now();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer = concatBuffer(buffer, value);

                    while (true) {
                        let boundaryIndex = decoder
                            .decode(buffer)
                            .indexOf("--frame");
                        if (boundaryIndex < 0) break;

                        let lenHeaderEnd = decoder
                            .decode(buffer.slice(boundaryIndex))
                            .indexOf("\r\n\r\n");
                        if (lenHeaderEnd < 0) break;

                        let headerStr = decoder.decode(
                            buffer.slice(
                                boundaryIndex,
                                boundaryIndex + lenHeaderEnd,
                            ),
                        );
                        let match = headerStr.match(/Content-Length: (\d+)/i);
                        if (!match) {
                            buffer = buffer.slice(boundaryIndex + lenHeaderEnd);
                            continue;
                        }

                        let contentLength = parseInt(match[1], 10);
                        let frameStart = boundaryIndex + lenHeaderEnd + 4;
                        if (buffer.length < frameStart + contentLength) break;

                        let frameData = buffer.slice(
                            frameStart,
                            frameStart + contentLength,
                        );
                        const blob = new Blob([frameData], {
                            type: "image/jpeg",
                        });
                        const img = new Image();
                        img.onload = () => {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            URL.revokeObjectURL(img.src);

                            // FPS 计算
                            frameCount++;
                            const now = performance.now();
                            if (now - lastTime >= 1000) {
                                fpsDisplay.textContent = `FPS: ${frameCount}`;
                                frameCount = 0;
                                lastTime = now;
                            }
                        };
                        img.src = URL.createObjectURL(blob);

                        buffer = buffer.slice(frameStart + contentLength);
                    }
                }
            }

            document
                .getElementById("play-btn")
                .addEventListener("click", () => {
                    streamMJPEG();
                });
        </script>
    </body>
</html>
